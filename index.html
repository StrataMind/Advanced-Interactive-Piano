<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Advanced Interactive Piano</title>
    <style>
      :root {
        --primary-color: #667eea;
        --secondary-color: #764ba2;
        --dark-color: #222;
        --light-color: #ffffff;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        min-height: 100vh;
        color: #333;
        position: relative;
        overflow-x: auto;
      }

      .light-grid-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        --color: #E1E1E1;
        background-color: #F3F3F3;
        background-image: linear-gradient(0deg, transparent 24%, var(--color) 25%, var(--color) 26%, transparent 27%,transparent 74%, var(--color) 75%, var(--color) 76%, transparent 77%,transparent),
            linear-gradient(90deg, transparent 24%, var(--color) 25%, var(--color) 26%, transparent 27%,transparent 74%, var(--color) 75%, var(--color) 76%, transparent 77%,transparent);
        background-size: 55px 55px;
      }

      .content-wrapper {
        position: relative;
        z-index: 1;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        background: rgba(255, 255, 255, 0.8);
      }


      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
        font-size: 3.5rem;
        font-weight: 700;
        background: linear-gradient(45deg, #36e2c9, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      @keyframes titleGlow {
        from { filter: drop-shadow(0 0 20px rgba(54, 226, 201, 0.5)); }
        to { filter: drop-shadow(0 0 40px rgba(233, 255, 112, 0.8)); }
      }

      .main-container {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 25px;
        padding: 40px;
        margin: 20px;
        max-width: 1400px;
        width: 95%;
        box-shadow: 
          0 10px 30px rgba(0, 0, 0, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.8);
        border: 2px solid rgba(54, 226, 201, 0.3);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
      }

      .main-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        animation: shimmer 3s infinite;
      }

      @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
      }

      .section-title {
        color: #667eea;
        font-size: 1.8rem;
        font-weight: bold;
        text-align: center;
        margin-bottom: 25px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .controls-section {
        background: rgba(255, 255, 255, 0.8);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        border: 1px solid rgba(54, 226, 201, 0.3);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .section-header {
        color: #36e2c9;
        font-size: 1.3rem;
        font-weight: bold;
        margin-bottom: 20px;
        text-align: center;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }

      .welcome-section {
        text-align: center;
        margin-bottom: 40px;
        background: linear-gradient(135deg, rgba(54, 226, 201, 0.1), rgba(102, 126, 234, 0.05));
        padding: 35px;
        border-radius: 20px;
        border: 2px solid rgba(54, 226, 201, 0.3);
        position: relative;
        overflow: hidden;
      }

      .welcome-section::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: conic-gradient(from 0deg, transparent, rgba(54, 226, 201, 0.1), transparent);
        animation: rotate 10s linear infinite;
      }

      .welcome-section > * {
        position: relative;
        z-index: 1;
      }

      @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      .welcome-title {
        color: #667eea;
        font-size: 1.8rem;
        margin-bottom: 15px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }

      .welcome-text {
        color: #555;
        font-size: 1.1rem;
        line-height: 1.6;
        max-width: 600px;
        margin: 0 auto;
      }

      .piano-options-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
        margin-bottom: 20px;
      }

      .piano-option {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(54, 226, 201, 0.05));
        border: 2px solid rgba(54, 226, 201, 0.3);
        border-radius: 20px;
        padding: 30px;
        text-align: center;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .piano-option::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(45deg, rgba(54, 226, 201, 0.1), rgba(233, 255, 112, 0.1));
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .piano-option:hover {
        border-color: rgba(54, 226, 201, 0.8);
        transform: translateY(-10px) scale(1.02);
        box-shadow: 
          0 20px 40px rgba(54, 226, 201, 0.3),
          0 0 0 1px rgba(255, 255, 255, 0.1);
      }

      .piano-option:hover::before {
        opacity: 1;
      }

      .piano-option > * {
        position: relative;
        z-index: 1;
      }

      .piano-icon {
        font-size: 3rem;
        margin-bottom: 15px;
        filter: drop-shadow(0 0 20px rgba(233, 255, 112, 0.5));
      }

      .piano-option h3 {
        color: #667eea;
        font-size: 1.4rem;
        margin-bottom: 15px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }

      .piano-option p {
        color: #555;
        font-size: 1rem;
        line-height: 1.5;
        margin-bottom: 20px;
      }

      .features {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 20px;
      }

      .feature {
        background: rgba(54, 226, 201, 0.1);
        color: #333;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        border: 1px solid rgba(54, 226, 201, 0.3);
      }

      .piano-btn {
        background: linear-gradient(45deg, rgb(54, 226, 201), rgb(102, 126, 234));
        color: white;
        border: none;
        padding: 15px 25px;
        border-radius: 25px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid rgba(54, 226, 201, 0.5);
        box-shadow: 0 5px 20px rgba(54, 226, 201, 0.3);
        width: 100%;
      }

      .piano-btn:hover {
        background: linear-gradient(45deg, rgb(84, 255, 216), rgb(118, 75, 162));
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(54, 226, 201, 0.5);
      }

      .controls-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .controls-panel {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        background: rgba(0, 0, 0, 0.3);
        padding: 20px;
        border-radius: 12px;
        border: 1px solid rgba(84, 255, 216, 0.2);
      }

      .control-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 120px;
      }

      .adsr-controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .adsr-control {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 80px;
      }

      .adsr-control input[type="range"] {
        width: 60px;
      }

      .effect-controls {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .metronome-controls {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .tempo-display {
        font-weight: bold;
        min-width: 60px;
        text-align: center;
      }

      .scale-controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .progression-controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .control-group label {
        margin-bottom: 5px;
        font-weight: bold;
      }

      .piano-container {
        background: #333;
        padding: 20px 20px 30px 20px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        position: relative;
        perspective: 500px;
        transform-style: preserve-3d;
        transition: transform 0.3s ease;
      }

      .piano-container:hover {
        transform: rotateX(5deg);
      }

      .piano {
        display: flex;
        position: relative;
        background: #222;
        padding: 10px;
        border-radius: 10px;
        box-shadow: inset 0 5px 15px rgba(0, 0, 0, 0.5);
        overflow-x: auto;
        overflow-y: hidden;
        min-width: 100%;
        scroll-behavior: smooth;
      }

      .piano::-webkit-scrollbar {
        height: 8px;
      }

      .piano::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 4px;
      }

      .piano::-webkit-scrollbar-thumb {
        background: rgba(54, 226, 201, 0.6);
        border-radius: 4px;
      }

      .piano::-webkit-scrollbar-thumb:hover {
        background: rgba(54, 226, 201, 0.8);
      }

      .key {
        cursor: pointer;
        user-select: none;
        transition: all 0.1s ease;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        font-weight: bold;
        font-size: 12px;
        padding-bottom: 10px;
        position: relative;
        overflow: hidden;
      }

      .key::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(
          circle at center,
          rgba(255, 255, 255, 0.8) 0%,
          rgba(255, 255, 255, 0) 70%
        );
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .white-key {
        width: 24px;
        height: 140px;
        background: linear-gradient(to bottom, #ffffff 0%, #f0f0f0 100%);
        border: 1px solid #ddd;
        border-radius: 0 0 4px 4px;
        margin: 0 0.5px;
        color: #666;
        flex-shrink: 0;
      }

      .white-key:hover {
        background: linear-gradient(to bottom, #f0f0f0 0%, #e0e0e0 100%);
      }

      .white-key:active,
      .white-key.pressed {
        background: linear-gradient(to bottom, #e0e0e0 0%, #d0d0d0 100%);
        transform: translateY(3px);
      }

      .white-key.pressed::after {
        opacity: 0.6;
      }

      .black-key {
        width: 16px;
        height: 90px;
        background: linear-gradient(to bottom, #333 0%, #000 100%);
        border: 1px solid #000;
        border-radius: 0 0 3px 3px;
        position: absolute;
        color: #ccc;
        z-index: 2;
        flex-shrink: 0;
      }

      .black-key:hover {
        background: linear-gradient(to bottom, #444 0%, #111 100%);
      }

      .black-key:active,
      .black-key.pressed {
        background: linear-gradient(to bottom, #222 0%, #000 100%);
        transform: translateY(3px);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      }

      .black-key.pressed::after {
        opacity: 0.3;
      }

      .instructions {
        color: white;
        font-size: 14px;
        line-height: 1.6;
      }

      .instruction-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
      }

      .instruction-item {
        background: rgba(84, 255, 216, 0.1);
        padding: 15px;
        border-radius: 10px;
        border: 1px solid rgba(84, 255, 216, 0.2);
        transition: all 0.3s ease;
      }

      .instruction-item:hover {
        background: rgba(84, 255, 216, 0.15);
        border-color: rgba(84, 255, 216, 0.4);
        transform: translateY(-2px);
      }

      .instruction-item strong {
        color: rgb(233, 255, 112);
        display: block;
        margin-bottom: 5px;
      }

      input[type="range"] {
        width: 100%;
        margin: 0 10px;
        height: 8px;
        border-radius: 5px;
        -webkit-appearance: none;
        background: rgba(255, 255, 255, 0.3);
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        background: white;
        border-radius: 50%;
        cursor: pointer;
      }

      select {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        padding: 8px 12px;
        border-radius: 5px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
      }

      select:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5);
      }

      button {
        padding: 12px 20px;
        border-radius: 10px;
        border: 0;
        background-color: rgb(54, 226, 201);
        letter-spacing: 1.5px;
        font-size: 14px;
        transition: all 0.3s ease;
        box-shadow: rgb(30, 180, 160) 0px 8px 0px 0px;
        color: hsl(0, 0%, 100%);
        cursor: pointer;
        font-weight: bold;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
      }

      button:hover {
        box-shadow: rgb(30, 180, 160) 0px 5px 0px 0px;
        transform: translateY(3px);
      }

      button:active {
        background-color: rgb(54, 226, 201);
        box-shadow: rgb(30, 180, 160) 0px 0px 0px 0px;
        transform: translateY(8px);
        transition: 200ms;
      }

      button:focus {
        outline: none;
        box-shadow: rgb(30, 180, 160) 0px 5px 0px 0px, 0 0 0 3px rgba(54, 226, 201, 0.4);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: rgb(30, 180, 160) 0px 3px 0px 0px;
      }

      button:disabled:hover {
        transform: none;
        box-shadow: rgb(30, 180, 160) 0px 3px 0px 0px;
      }

      /* Special button styles for different actions */
      #recordBtn {
        background-color: rgb(255, 56, 86);
        box-shadow: rgb(201, 46, 70) 0px 8px 0px 0px;
      }

      #recordBtn:hover {
        box-shadow: rgb(201, 46, 70) 0px 5px 0px 0px;
      }

      #recordBtn:active {
        background-color: rgb(255, 56, 86);
        box-shadow: rgb(201, 46, 70) 0px 0px 0px 0px;
      }

      #recordBtn:focus {
        box-shadow: rgb(201, 46, 70) 0px 5px 0px 0px, 0 0 0 3px rgba(255, 56, 86, 0.4);
      }

      #playBtn, #playScaleBtn, #playProgressionBtn {
        background-color: rgb(76, 175, 80);
        box-shadow: rgb(56, 142, 60) 0px 8px 0px 0px;
      }

      #playBtn:hover, #playScaleBtn:hover, #playProgressionBtn:hover {
        box-shadow: rgb(56, 142, 60) 0px 5px 0px 0px;
      }

      #playBtn:active, #playScaleBtn:active, #playProgressionBtn:active {
        background-color: rgb(76, 175, 80);
        box-shadow: rgb(56, 142, 60) 0px 0px 0px 0px;
      }

      #playBtn:focus, #playScaleBtn:focus, #playProgressionBtn:focus {
        box-shadow: rgb(56, 142, 60) 0px 5px 0px 0px, 0 0 0 3px rgba(76, 175, 80, 0.4);
      }

      #saveBtn, #saveMidiBtn {
        background-color: rgb(156, 39, 176);
        box-shadow: rgb(123, 31, 162) 0px 8px 0px 0px;
      }

      #saveBtn:hover, #saveMidiBtn:hover {
        box-shadow: rgb(123, 31, 162) 0px 5px 0px 0px;
      }

      #saveBtn:active, #saveMidiBtn:active {
        background-color: rgb(156, 39, 176);
        box-shadow: rgb(123, 31, 162) 0px 0px 0px 0px;
      }

      #saveBtn:focus, #saveMidiBtn:focus {
        box-shadow: rgb(123, 31, 162) 0px 5px 0px 0px, 0 0 0 3px rgba(156, 39, 176, 0.4);
      }

      #metronomeBtn {
        background-color: rgb(255, 152, 0);
        box-shadow: rgb(239, 108, 0) 0px 8px 0px 0px;
      }

      #metronomeBtn:hover {
        box-shadow: rgb(239, 108, 0) 0px 5px 0px 0px;
      }

      #metronomeBtn:active {
        background-color: rgb(255, 152, 0);
        box-shadow: rgb(239, 108, 0) 0px 0px 0px 0px;
      }

      #metronomeBtn:focus {
        box-shadow: rgb(239, 108, 0) 0px 5px 0px 0px, 0 0 0 3px rgba(255, 152, 0, 0.4);
      }

      .recording-controls {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      .recording {
        color: #ff4c4c;
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      .ripple {
        position: absolute;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.7);
        transform: scale(0);
        animation: ripple 0.6s linear;
        pointer-events: none;
      }

      @keyframes ripple {
        to {
          transform: scale(2);
          opacity: 0;
        }
      }

      .visualizer-container {
        width: 100%;
        height: 60px;
        margin: 10px 0;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 5px;
        position: relative;
        overflow: hidden;
      }

      .visualizer {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        height: 100%;
        padding: 0 5px;
      }

      .visualizer-bar {
        background: white;
        width: 5px;
        height: 5px;
        margin: 0 1px;
        border-radius: 3px 3px 0 0;
        transition: height 0.1s ease;
      }

      .note-display {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.7);
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 16px;
        font-weight: bold;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
      }

      .piano-range-controls {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }


      .key-binding {
        position: absolute;
        bottom: 35px;
        font-size: 10px;
        color: #999;
        background: rgba(0, 0, 0, 0.2);
        padding: 2px 6px;
        border-radius: 10px;
      }

      .white-key .key-binding {
        color: #666;
        background: rgba(0, 0, 0, 0.1);
      }

      /* Black keys are positioned dynamically by JavaScript */

      /* Accessibility improvements */
      .key:focus {
        outline: 3px solid #ff6b6b;
        outline-offset: 2px;
      }

      .key[aria-pressed="true"] {
        transform: translateY(3px);
      }

      /* Screen reader only content */
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      /* High contrast mode support */
      @media (prefers-contrast: high) {
        .key {
          border-width: 3px;
        }
        .white-key {
          border-color: #000;
        }
        .black-key {
          border-color: #fff;
        }
      }

      /* Reduce motion for users who prefer it */
      @media (prefers-reduced-motion: reduce) {
        .key,
        .piano-container,
        .ripple {
          animation: none;
          transition: none;
        }
      }

      /* Responsive design */
      @media (max-width: 1024px) {
        .main-container {
          margin: 10px;
          padding: 20px;
        }

        .controls-grid {
          grid-template-columns: 1fr;
        }

        .controls-panel {
          max-width: 100%;
          padding: 15px;
        }

        .effect-controls,
        .adsr-controls {
          flex-direction: column;
          gap: 8px;
        }

        .instruction-grid {
          grid-template-columns: 1fr;
        }

        .section-title {
          font-size: 1.5rem;
        }

        .section-header {
          font-size: 1.1rem;
        }

        .piano-options-grid {
          grid-template-columns: 1fr;
        }

        .lessons-grid {
          grid-template-columns: 1fr;
        }
      }

      .learner-book {
        max-width: 100%;
      }

      .lesson-category {
        margin-bottom: 40px;
      }

      .category-title {
        color: rgb(233, 255, 112);
        font-size: 1.6rem;
        margin-bottom: 20px;
        text-align: center;
        text-shadow: 0 0 20px rgba(233, 255, 112, 0.5);
        border-bottom: 2px solid rgba(54, 226, 201, 0.3);
        padding-bottom: 10px;
      }

      .lessons-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
      }

      .lesson-card {
        background: rgba(54, 226, 201, 0.1);
        border: 2px solid rgba(54, 226, 201, 0.3);
        border-radius: 15px;
        padding: 20px;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }

      .lesson-card:hover {
        border-color: rgba(54, 226, 201, 0.6);
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(54, 226, 201, 0.2);
      }

      .lesson-card h4 {
        color: rgb(233, 255, 112);
        font-size: 1.3rem;
        margin-bottom: 12px;
        text-shadow: 0 0 15px rgba(233, 255, 112, 0.5);
      }

      .lesson-card p {
        color: rgb(54, 226, 201);
        font-size: 1rem;
        line-height: 1.5;
        margin-bottom: 15px;
      }

      .lesson-points {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .lesson-points li {
        color: white;
        font-size: 0.9rem;
        margin-bottom: 8px;
        padding: 5px 10px;
        background: rgba(54, 226, 201, 0.1);
        border-radius: 8px;
        border-left: 3px solid rgba(54, 226, 201, 0.6);
      }

      @media (max-width: 768px) {
        .content-wrapper {
          padding: 10px;
        }

        .main-container {
          padding: 15px;
        }

        .white-key {
          width: 20px;
          height: 120px;
          font-size: 8px;
        }

        .black-key {
          width: 12px;
          height: 75px;
          font-size: 7px;
        }

        .key-binding {
          font-size: 6px;
          padding: 1px 3px;
        }

        .controls-panel {
          flex-direction: column;
          gap: 15px;
          padding: 10px;
        }

        .adsr-controls,
        .effect-controls {
          flex-direction: column;
          gap: 8px;
        }

        .scale-controls,
        .progression-controls,
        .metronome-controls {
          flex-direction: column;
          gap: 8px;
        }

        .visualizer-container {
          height: 40px;
        }

        .piano-container {
          padding: 10px;
        }
      }

      @media (max-width: 480px) {
        .white-key {
          width: 18px;
          height: 100px;
          margin: 0 0.25px;
        }

        .black-key {
          width: 10px;
          height: 60px;
        }

        .control-group {
          width: 100%;
          min-width: auto;
        }

        .control-group label {
          font-size: 12px;
        }

        .instructions {
          font-size: 12px;
          padding: 8px;
        }

        .section-title {
          font-size: 1.2rem;
        }

        .piano-container {
          padding: 8px;
        }

        .piano {
          padding: 5px;
        }
      }

      /* Touch improvements */
      @media (hover: none) and (pointer: coarse) {
        .key {
          min-height: 44px; /* Minimum touch target size */
        }

        .white-key {
          min-width: 44px;
        }

        button,
        select,
        input[type="range"] {
          min-height: 44px;
          min-width: 44px;
        }
      }
    </style>
  </head>
  <body>
    <div class="light-grid-bg"></div>

    <div class="content-wrapper">

      <div class="main-container">
        <div class="section-title">
          üéπ Advanced Piano Studio
        </div>

        <div class="welcome-section">
          <h2 class="welcome-title">Welcome to Your Musical Journey!</h2>
          <p class="welcome-text">Choose your preferred piano style and start creating beautiful music. Each piano offers unique features and experiences.</p>
        </div>

        <!-- Piano Selection Section -->
        <div class="controls-section">
          <div class="section-header">üéπ Choose Your Piano Style</div>
          <div class="piano-options-grid">
            <div class="piano-option">
              <div class="piano-icon">‚≠ï</div>
              <h3>Round Piano</h3>
              <p>Revolutionary circular design with all 88 keys arranged in a perfect circle. No scrolling needed!</p>
              <div class="features">
                <span class="feature">‚ú® All keys visible</span>
                <span class="feature">üé® Futuristic design</span>
                <span class="feature">üì± Mobile friendly</span>
              </div>
              <button class="piano-btn" onclick="window.open('round-piano.html', '_blank')">
                üåü Try Round Piano
              </button>
            </div>

            <div class="piano-option">
              <div class="piano-icon">üìè</div>
              <h3>Traditional Piano</h3>
              <p>Classic 88-key layout with horizontal scrolling. Traditional piano experience with modern features.</p>
              <div class="features">
                <span class="feature">üéº Classic layout</span>
                <span class="feature">‚¨ÖÔ∏è‚û°Ô∏è Horizontal scroll</span>
                <span class="feature">üéπ 88 real keys</span>
              </div>
              <button class="piano-btn" onclick="window.open('piano-real.html', '_blank')">
                üéπ Try Traditional Piano
              </button>
            </div>


          </div>
        </div>

        <!-- Piano Learning Book Section -->
        <div class="controls-section">
          <div class="section-header">üìö Piano Learning Book</div>
          <div class="learner-book">

            <div class="lesson-category">
              <h3 class="category-title">üéØ Basic Fundamentals</h3>
              <div class="lessons-grid">
                <div class="lesson-card">
                  <h4>üéπ Piano Basics</h4>
                  <p>Learn about piano keys, white and black keys, and basic hand positioning.</p>
                  <ul class="lesson-points">
                    <li>‚Ä¢ 88 keys: 52 white + 36 black</li>
                    <li>‚Ä¢ Pattern: 7 white keys per octave</li>
                    <li>‚Ä¢ Hand position and posture</li>
                  </ul>
                </div>

                <div class="lesson-card">
                  <h4>üéº Musical Notes</h4>
                  <p>Understand note names, octaves, and how they relate to piano keys.</p>
                  <ul class="lesson-points">
                    <li>‚Ä¢ Note names: C D E F G A B</li>
                    <li>‚Ä¢ Sharp (#) and flat (‚ô≠) notes</li>
                    <li>‚Ä¢ Octave system (C0 to C8)</li>
                  </ul>
                </div>

                <div class="lesson-card">
                  <h4>‚è±Ô∏è Rhythm & Timing</h4>
                  <p>Learn about beats, tempo, and basic rhythm patterns.</p>
                  <ul class="lesson-points">
                    <li>‚Ä¢ BPM (Beats Per Minute)</li>
                    <li>‚Ä¢ Quarter, half, whole notes</li>
                    <li>‚Ä¢ Count: 1-2-3-4</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="lesson-category">
              <h3 class="category-title">üéµ Scales & Chords</h3>
              <div class="lessons-grid">
                <div class="lesson-card">
                  <h4>üéº Major Scale</h4>
                  <p>The foundation of Western music. Pattern: W-W-H-W-W-W-H</p>
                  <ul class="lesson-points">
                    <li>‚Ä¢ C Major: C D E F G A B</li>
                    <li>‚Ä¢ No sharps or flats</li>
                    <li>‚Ä¢ Whole (W) and Half (H) steps</li>
                  </ul>
                </div>

                <div class="lesson-card">
                  <h4>üéπ Basic Chords</h4>
                  <p>Learn to play your first chords: triads and basic progressions.</p>
                  <ul class="lesson-points">
                    <li>‚Ä¢ C Major: C-E-G</li>
                    <li>‚Ä¢ F Major: F-A-C</li>
                    <li>‚Ä¢ G Major: G-B-D</li>
                  </ul>
                </div>

                <div class="lesson-card">
                  <h4>üéµ Chord Progressions</h4>
                  <p>Popular chord sequences used in thousands of songs.</p>
                  <ul class="lesson-points">
                    <li>‚Ä¢ I-V-vi-IV (Pop progression)</li>
                    <li>‚Ä¢ ii-V-I (Jazz standard)</li>
                    <li>‚Ä¢ Practice with both hands</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="lesson-category">
              <h3 class="category-title">üéØ Practice Tips</h3>
              <div class="lessons-grid">
                <div class="lesson-card">
                  <h4>üïê Daily Practice</h4>
                  <p>Build a consistent practice routine for steady improvement.</p>
                  <ul class="lesson-points">
                    <li>‚Ä¢ Start with 15-30 minutes daily</li>
                    <li>‚Ä¢ Warm up with scales</li>
                    <li>‚Ä¢ Focus on one song at a time</li>
                  </ul>
                </div>

                <div class="lesson-card">
                  <h4>üéØ Technique Tips</h4>
                  <p>Proper technique prevents injury and improves sound quality.</p>
                  <ul class="lesson-points">
                    <li>‚Ä¢ Curved fingers, relaxed wrists</li>
                    <li>‚Ä¢ Practice slowly first</li>
                    <li>‚Ä¢ Use metronome for timing</li>
                  </ul>
                </div>

                <div class="lesson-card">
                  <h4>üéµ Song Learning</h4>
                  <p>Step-by-step approach to learning new pieces.</p>
                  <ul class="lesson-points">
                    <li>‚Ä¢ Learn hands separately first</li>
                    <li>‚Ä¢ Practice difficult sections slowly</li>
                    <li>‚Ä¢ Gradually increase tempo</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="lesson-category">
              <h3 class="category-title">üéπ Using Our Pianos</h3>
              <div class="lessons-grid">
                <div class="lesson-card">
                  <h4>‚≠ï Round Piano</h4>
                  <p>Perfect for visualizing all keys and understanding piano layout.</p>
                  <ul class="lesson-points">
                    <li>‚Ä¢ See all 88 keys at once</li>
                    <li>‚Ä¢ Great for chord visualization</li>
                    <li>‚Ä¢ Touch-friendly on mobile</li>
                  </ul>
                </div>

                <div class="lesson-card">
                  <h4>üìè Traditional Piano</h4>
                  <p>Classic layout for authentic piano experience.</p>
                  <ul class="lesson-points">
                    <li>‚Ä¢ Standard keyboard layout</li>
                    <li>‚Ä¢ Scroll to access all octaves</li>
                    <li>‚Ä¢ Best for serious practice</li>
                  </ul>
                </div>

                <div class="lesson-card">
                  <h4>üéØ Compact Piano</h4>
                  <p>Beginner-friendly with octave switching.</p>
                  <ul class="lesson-points">
                    <li>‚Ä¢ Simple 9-key layout</li>
                    <li>‚Ä¢ Switch octaves with +/- buttons</li>
                    <li>‚Ä¢ Perfect for learning scales</li>
                  </ul>
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- Instructions Section -->
        <div class="controls-section">
          <div class="section-header">üìñ How to Use</div>
          <div class="instructions">
            <div class="instruction-grid">
              <div class="instruction-item">
                <strong>üéπ Playing:</strong> Click keys, use keyboard shortcuts, or tab to navigate and press Enter/Space
              </div>
              <div class="instruction-item">
                <strong>‚å®Ô∏è Shortcuts:</strong> 9 keys: A S D F G H J K L (white keys C D E F G A B C D)
              </div>
              <div class="instruction-item">
                <strong>üéõÔ∏è Controls:</strong> Change octaves with +/- buttons to access all notes. ADSR envelope, multiple instruments, reverb, delay, filter
              </div>
              <div class="instruction-item">
                <strong>üéµ Musical Features:</strong> Extended chords, scales, chord progressions, metronome
              </div>
              <div class="instruction-item">
                <strong>üéß Recording:</strong> Record performances, save as WAV or MIDI files
              </div>
              <div class="instruction-item">
                <strong>üì± Accessibility:</strong> Full keyboard navigation, screen reader support, touch-friendly
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // State variables
      let audioContext;
      let masterGainNode;
      let reverbNode;
      let delayNode;
      let filterNode;
      let volume = 0.5;
      let reverbLevel = 0.5;
      let delayLevel = 0;
      let filterFreq = 5000;
      let currentInstrument = "piano";
      let currentOctave = 4;
      let isRecording = false;
      let recordedNotes = [];
      let recordStartTime = 0;
      let activeNotes = new Map();
      let isMetronomeRunning = false;
      let metronomeInterval;
      let currentTempo = 120;

      // ADSR envelope parameters
      let attackTime = 0.1;
      let decayTime = 0.3;
      let sustainLevel = 0.7;
      let releaseTime = 0.5;

      // Create visualizer bars
      const visualizer = document.getElementById("visualizer");
      const barCount = 32;
      for (let i = 0; i < barCount; i++) {
        const bar = document.createElement("div");
        bar.className = "visualizer-bar";
        visualizer.appendChild(bar);
      }
      const visualizerBars = document.querySelectorAll(".visualizer-bar");

      // Piano keyboard generation - Simplified to 9 white keys
      function generatePianoKeyboard() {
        const piano = document.getElementById("piano");
        const whiteNotes = ['C', 'D', 'E', 'F', 'G', 'A', 'B', 'C', 'D']; // 9 white keys
        const keyboardKeys = ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l']; // Simple keyboard mapping

        // Generate 9 white keys
        whiteNotes.forEach((noteName, index) => {
          const whiteKey = document.createElement('div');
          whiteKey.className = 'key white-key';

          // Use current octave for note naming
          const noteString = `${noteName}${currentOctave}`;
          whiteKey.dataset.note = noteString;
          whiteKey.dataset.keyIndex = index;
          whiteKey.setAttribute('role', 'button');
          whiteKey.setAttribute('tabindex', '0');
          whiteKey.setAttribute('aria-label', `${noteString} note`);

          // Add keyboard shortcuts
          const keyboardKey = keyboardKeys[index];
          whiteKey.dataset.key = keyboardKey;
          whiteKey.innerHTML = `${noteName}<span class="key-binding">${keyboardKey.toUpperCase()}</span>`;
          whiteKey.innerHTML += `<span class="sr-only">Piano key ${noteString}</span>`;

          piano.appendChild(whiteKey);
        });
      }

      // Function to regenerate piano keys when octave changes
      function regeneratePianoKeys() {
        const piano = document.getElementById("piano");
        piano.innerHTML = ''; // Clear existing keys
        generatePianoKeyboard(); // Generate new keys with current octave
      }

      // Initialize audio context
      function initAudio() {
        if (!audioContext) {
          audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();

          // Create master gain node for volume control
          masterGainNode = audioContext.createGain();
          masterGainNode.gain.value = volume;
          masterGainNode.connect(audioContext.destination);

          // Create convolver node for reverb
          reverbNode = audioContext.createConvolver();
          createReverb();

          // Create delay node
          delayNode = audioContext.createDelay(1.0);
          delayNode.delayTime.value = 0.3;
          const delayFeedback = audioContext.createGain();
          delayFeedback.gain.value = 0.3;
          const delayGain = audioContext.createGain();
          delayGain.gain.value = delayLevel;

          delayNode.connect(delayFeedback);
          delayFeedback.connect(delayNode);
          delayNode.connect(delayGain);
          delayGain.connect(masterGainNode);

          // Create filter node
          filterNode = audioContext.createBiquadFilter();
          filterNode.type = "lowpass";
          filterNode.frequency.value = filterFreq;
          filterNode.Q.value = 1;
          filterNode.connect(masterGainNode);
        }
      }

      // Create reverb impulse response
      function createReverb() {
        const duration = 2.0;
        const decay = 2.0;
        const sampleRate = audioContext.sampleRate;
        const length = sampleRate * duration;
        const impulse = audioContext.createBuffer(2, length, sampleRate);
        const leftChannel = impulse.getChannelData(0);
        const rightChannel = impulse.getChannelData(1);

        for (let i = 0; i < length; i++) {
          const n = i / length;
          // Random noise with exponential decay
          leftChannel[i] = (Math.random() * 2 - 1) * Math.pow(1 - n, decay);
          rightChannel[i] = (Math.random() * 2 - 1) * Math.pow(1 - n, decay);
        }

        reverbNode.buffer = impulse;

        // Connect the reverb in parallel with dry signal
        const reverbGain = audioContext.createGain();
        reverbGain.gain.value = reverbLevel;
        reverbNode.connect(reverbGain);
        reverbGain.connect(masterGainNode);
      }

      // Calculate note frequency based on note name and octave
      function getFrequency(noteString, octaveOverride = null) {
        const notes = {
          C: 0, "C#": 1, D: 2, "D#": 3, E: 4, F: 5, "F#": 6, G: 7, "G#": 8, A: 9, "A#": 10, B: 11
        };

        let noteName, octave;

        // Handle both old format (note + octaveOverride) and new format (noteString with octave)
        if (octaveOverride !== null) {
          noteName = noteString.replace(/\d+$/, ''); // Remove any numbers
          octave = octaveOverride;
        } else {
          // Extract note name and octave from string like "C4", "A#3", etc.
          const match = noteString.match(/^([A-G]#?)(\d+)$/);
          if (match) {
            noteName = match[1];
            octave = parseInt(match[2]);
          } else {
            // Fallback for old format
            noteName = noteString.replace(/\d+$/, '');
            octave = currentOctave;
          }
        }

        const semitonesFromA4 = (octave - 4) * 12 + notes[noteName] - notes["A"];
        return 440 * Math.pow(2, semitonesFromA4 / 12);
      }

      // Create sophisticated instrument synthesis
      function createInstrumentSound(frequency) {
        const nodes = [];

        switch (currentInstrument) {
          case "piano":
            // Complex piano synthesis with multiple harmonics
            const fundamental = audioContext.createOscillator();
            fundamental.frequency.value = frequency;
            fundamental.type = "triangle";

            const harmonic2 = audioContext.createOscillator();
            harmonic2.frequency.value = frequency * 2;
            harmonic2.type = "sine";

            const harmonic3 = audioContext.createOscillator();
            harmonic3.frequency.value = frequency * 3;
            harmonic3.type = "sine";

            const harmonicGain2 = audioContext.createGain();
            harmonicGain2.gain.value = 0.3;
            const harmonicGain3 = audioContext.createGain();
            harmonicGain3.gain.value = 0.1;

            harmonic2.connect(harmonicGain2);
            harmonic3.connect(harmonicGain3);

            nodes.push(
              fundamental,
              harmonic2,
              harmonic3,
              harmonicGain2,
              harmonicGain3
            );
            return {
              oscillators: [fundamental, harmonic2, harmonic3],
              gainNodes: [harmonicGain2, harmonicGain3],
            };

          case "electric":
            const electric = audioContext.createOscillator();
            electric.frequency.value = frequency;
            electric.type = "sawtooth";
            nodes.push(electric);
            return { oscillators: [electric], gainNodes: [] };

          case "organ":
            const organ = audioContext.createOscillator();
            organ.frequency.value = frequency;
            organ.type = "square";
            nodes.push(organ);
            return { oscillators: [organ], gainNodes: [] };

          case "synth":
            const synth = audioContext.createOscillator();
            synth.frequency.value = frequency;
            synth.type = "sawtooth";
            nodes.push(synth);
            return { oscillators: [synth], gainNodes: [] };

          case "strings":
            const strings = audioContext.createOscillator();
            strings.frequency.value = frequency;
            strings.type = "sawtooth";
            const stringFilter = audioContext.createBiquadFilter();
            stringFilter.type = "lowpass";
            stringFilter.frequency.value = frequency * 4;
            strings.connect(stringFilter);
            nodes.push(strings, stringFilter);
            return {
              oscillators: [strings],
              gainNodes: [],
              filter: stringFilter,
            };

          case "brass":
            const brass = audioContext.createOscillator();
            brass.frequency.value = frequency;
            brass.type = "square";
            nodes.push(brass);
            return { oscillators: [brass], gainNodes: [] };

          default: // music-box
            const musicBox = audioContext.createOscillator();
            musicBox.frequency.value = frequency;
            musicBox.type = "triangle";
            nodes.push(musicBox);
            return { oscillators: [musicBox], gainNodes: [] };
        }
      }

      // Play a note with enhanced synthesis and ADSR
      function playNote(noteString, duration = 2, velocity = 1) {
        initAudio();

        // Display the note being played
        document.getElementById("noteDisplay").textContent = noteString;

        // Calculate frequency based on note string (e.g., "C4", "A#3")
        const frequency = getFrequency(noteString);

        // Create instrument sound
        const instrument = createInstrumentSound(frequency);

        // Create main gain node for ADSR envelope
        const envelopeGain = audioContext.createGain();
        envelopeGain.gain.setValueAtTime(0, audioContext.currentTime);

        // Connect oscillators to envelope gain
        instrument.oscillators.forEach((osc) => {
          if (instrument.filter) {
            instrument.filter.connect(envelopeGain);
          } else {
            osc.connect(envelopeGain);
          }
        });

        // Connect additional gain nodes
        instrument.gainNodes.forEach((gainNode) => {
          gainNode.connect(envelopeGain);
        });

        // Connect to effects chain
        envelopeGain.connect(filterNode);
        envelopeGain.connect(delayNode);
        envelopeGain.connect(reverbNode);

        // Apply ADSR envelope
        const now = audioContext.currentTime;
        const attackTarget = volume * velocity * sustainLevel;
        const sustainTarget = volume * velocity * sustainLevel;

        // Attack
        envelopeGain.gain.linearRampToValueAtTime(
          volume * velocity,
          now + attackTime
        );
        // Decay
        envelopeGain.gain.linearRampToValueAtTime(
          sustainTarget,
          now + attackTime + decayTime
        );
        // Sustain (held until release)
        // Release
        envelopeGain.gain.setValueAtTime(
          sustainTarget,
          now + duration - releaseTime
        );
        envelopeGain.gain.exponentialRampToValueAtTime(0.001, now + duration);

        // Start oscillators
        instrument.oscillators.forEach((osc) => {
          osc.start(now);
          osc.stop(now + duration);
        });

        // Store the note for active visualization
        const noteInfo = {
          frequency,
          gainNode: envelopeGain,
          oscillators: instrument.oscillators,
          startTime: now,
        };
        activeNotes.set(noteString, noteInfo);

        // Remove from active notes after it stops
        setTimeout(() => {
          activeNotes.delete(noteString);
        }, duration * 1000);

        // Record the note if recording is active
        if (isRecording) {
          recordedNotes.push({
            noteString: noteString,
            time: now - recordStartTime,
            duration: duration,
            velocity: velocity,
          });
        }

        // Animate visualizer for this note
        animateVisualizer(frequency);

        return { oscillators: instrument.oscillators, gainNode: envelopeGain };
      }

      // Animate visualizer
      function animateVisualizer(frequency) {
        // Map frequency to a position in the visualizer
        const normalizedFreq = Math.min(Math.max(frequency / 1000, 0), 1);
        const barIndex = Math.floor(normalizedFreq * barCount);

        // Animate all bars with emphasis on the frequency's bar
        visualizerBars.forEach((bar, index) => {
          let height;
          if (index === barIndex) {
            height = 95; // Main frequency bar
          } else {
            // Height decreases as distance from main bar increases
            const distance = Math.abs(index - barIndex);
            height = Math.max(5, 95 - distance * 15);
          }

          // Add some randomness
          height += Math.random() * 10 - 5;

          // Ensure height is within bounds
          height = Math.max(5, Math.min(95, height));

          // Apply the height
          bar.style.height = height + "%";

          // Color based on frequency (hue)
          const hue = (normalizedFreq * 270) % 360;
          bar.style.background = `hsl(${hue}, 80%, 60%)`;
        });
      }

      // Update visualizer based on active notes
      function updateVisualizer() {
        if (activeNotes.size === 0) {
          // No active notes, reset visualizer
          visualizerBars.forEach((bar) => {
            bar.style.height = "5%";
            bar.style.background = "white";
          });
          return;
        }

        // Calculate average frequency of all active notes
        let totalFreq = 0;
        activeNotes.forEach((note) => {
          totalFreq += note.frequency;
        });
        const avgFreq = totalFreq / activeNotes.size;

        // Animate visualizer based on average frequency
        animateVisualizer(avgFreq);
      }

      // Handle key press visual feedback
      function pressKey(keyElement) {
        if (!keyElement) return;

        // Add pressed class for styling
        keyElement.classList.add("pressed");

        // Add ripple effect
        const ripple = document.createElement("div");
        ripple.className = "ripple";
        keyElement.appendChild(ripple);

        // Clean up after animation
        setTimeout(() => {
          keyElement.classList.remove("pressed");
          ripple.remove();
        }, 300);
      }

      // Extended chord library
      function playChord(chordName) {
        const chords = {
          C: ["C", "E", "G"],
          Cm: ["C", "D#", "G"],
          Cdim: ["C", "D#", "F#"],
          Caug: ["C", "E", "G#"],
          C7: ["C", "E", "G", "A#"],
          Cmaj7: ["C", "E", "G", "B"],
          Cm7: ["C", "D#", "G", "A#"],
          C9: ["C", "E", "G", "A#", "D2"],
          G: ["G", "B", "D2"],
          Gm: ["G", "A#", "D2"],
          F: ["F", "A", "C2"],
          D: ["D", "F#", "A"],
          A: ["A", "C#2", "E"],
          E: ["E", "G#", "B"],
        };

        if (!chords[chordName]) return;

        // Play each note in the chord
        chords[chordName].forEach((note, index) => {
          setTimeout(() => {
            // Find the key element
            const keyElement = document.querySelector(`[data-note="${note}"]`);
            if (keyElement) {
              // Visually press the key
              pressKey(keyElement);
              // Play the note
              playNote(note, 2, 0.8);
            }
          }, index * 30); // Slight delay between notes for arpeggio effect
        });
      }

      // Scale definitions
      function getScale(root, scaleType) {
        const scalePatterns = {
          major: [0, 2, 4, 5, 7, 9, 11],
          minor: [0, 2, 3, 5, 7, 8, 10],
          pentatonic: [0, 2, 4, 7, 9],
          blues: [0, 3, 5, 6, 7, 10],
          chromatic: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11],
        };

        const notes = [
          "C",
          "C#",
          "D",
          "D#",
          "E",
          "F",
          "F#",
          "G",
          "G#",
          "A",
          "A#",
          "B",
        ];
        const rootIndex = notes.indexOf(root);
        const pattern = scalePatterns[scaleType];

        return pattern.map((interval) => {
          const noteIndex = (rootIndex + interval) % 12;
          return notes[noteIndex];
        });
      }

      // Play scale
      function playScale(root, scaleType) {
        const scale = getScale(root, scaleType);
        scale.forEach((note, index) => {
          setTimeout(() => {
            const keyElement = document.querySelector(`[data-note="${note}"]`);
            if (keyElement) {
              pressKey(keyElement);
              playNote(note, 0.5, 0.7);
            }
          }, index * 200);
        });
      }

      // Chord progressions
      function playProgression(progressionName) {
        const progressions = {
          "I-V-vi-IV": ["C", "G", "A", "F"], // Pop progression in C major
          "ii-V-I": ["D", "G", "C"], // Jazz progression
          "I-vi-IV-V": ["C", "A", "F", "G"], // 50s progression
          "vi-IV-I-V": ["A", "F", "C", "G"], // Ballad progression
        };

        const progression = progressions[progressionName];
        if (!progression) return;

        progression.forEach((chord, index) => {
          setTimeout(() => {
            playChord(chord);
          }, index * 2000); // 2 seconds between chords
        });
      }

      // Metronome functionality
      function toggleMetronome() {
        if (isMetronomeRunning) {
          clearInterval(metronomeInterval);
          isMetronomeRunning = false;
          document.getElementById("metronomeBtn").textContent = "‚è±Ô∏è Start";
        } else {
          startMetronome();
          isMetronomeRunning = true;
          document.getElementById("metronomeBtn").textContent = "‚èπÔ∏è Stop";
        }
      }

      function startMetronome() {
        const interval = 60000 / currentTempo; // Convert BPM to milliseconds
        metronomeInterval = setInterval(() => {
          // Create a short click sound
          const clickOsc = audioContext.createOscillator();
          const clickGain = audioContext.createGain();

          clickOsc.connect(clickGain);
          clickGain.connect(masterGainNode);

          clickOsc.frequency.value = 1000;
          clickOsc.type = "square";

          clickGain.gain.setValueAtTime(0.1, audioContext.currentTime);
          clickGain.gain.exponentialRampToValueAtTime(
            0.001,
            audioContext.currentTime + 0.1
          );

          clickOsc.start(audioContext.currentTime);
          clickOsc.stop(audioContext.currentTime + 0.1);
        }, interval);
      }

      // Play recorded notes
      function playRecording() {
        if (recordedNotes.length === 0) return;

        // Disable buttons during playback
        document.getElementById("playBtn").disabled = true;
        document.getElementById("recordBtn").disabled = true;

        // Reset any active notes
        activeNotes.clear();

        // Get the starting time
        const startTime = audioContext.currentTime;

        // Play each recorded note at its recorded time
        recordedNotes.forEach((noteInfo) => {
          setTimeout(() => {
            // Find the key element
            const keyElement = document.querySelector(
              `[data-note="${noteInfo.noteString}"]`
            );
            if (keyElement) {
              // Visually press the key
              pressKey(keyElement);

              // Play the note
              playNote(noteInfo.noteString, noteInfo.duration, noteInfo.velocity);
            }
          }, noteInfo.time * 1000);
        });

        // Re-enable buttons after playback finishes
        const lastNote = recordedNotes[recordedNotes.length - 1];
        const recordingDuration = lastNote.time + lastNote.duration;

        setTimeout(() => {
          document.getElementById("playBtn").disabled = false;
          document.getElementById("recordBtn").disabled = false;
        }, recordingDuration * 1000 + 100);
      }

      // Save recording as audio file
      function saveRecording() {
        if (recordedNotes.length === 0) return;

        // Create offline audio context for rendering
        const offlineCtx = new OfflineAudioContext(
          2, // stereo
          44100 * 60, // 60 seconds max at 44.1kHz
          44100 // sample rate
        );

        // Create master gain node for the offline context
        const offlineMaster = offlineCtx.createGain();
        offlineMaster.gain.value = volume;
        offlineMaster.connect(offlineCtx.destination);

        // Render each note
        recordedNotes.forEach((noteInfo) => {
          const oscillator = offlineCtx.createOscillator();
          const gainNode = offlineCtx.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(offlineMaster);

          oscillator.type = currentInstrument;
          oscillator.frequency.value = getFrequency(noteInfo.noteString);

          const startTime = noteInfo.time;
          const stopTime = startTime + noteInfo.duration;

          gainNode.gain.setValueAtTime(volume, startTime);
          gainNode.gain.exponentialRampToValueAtTime(0.001, stopTime);

          oscillator.start(startTime);
          oscillator.stop(stopTime);
        });

        // Get the last note to determine recording length
        const lastNote = recordedNotes[recordedNotes.length - 1];
        const recordingDuration = lastNote.time + lastNote.duration;

        // Start rendering
        offlineCtx
          .startRendering()
          .then((renderedBuffer) => {
            // Create WAV file from buffer
            const wavBlob = audioBufferToWav(renderedBuffer);

            // Create download link
            const downloadLink = document.createElement("a");
            downloadLink.href = URL.createObjectURL(wavBlob);
            downloadLink.download = "piano-recording.wav";

            // Trigger download
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
          })
          .catch((err) => {
            console.error("Error rendering audio:", err);
          });
      }

      // Convert AudioBuffer to WAV format
      // Based on https://github.com/Jam3/audiobuffer-to-wav
      function audioBufferToWav(buffer) {
        const numChannels = buffer.numberOfChannels;
        const sampleRate = buffer.sampleRate;
        const format = 1; // PCM
        const bitDepth = 16;

        const bytesPerSample = bitDepth / 8;
        const blockAlign = numChannels * bytesPerSample;

        const dataLength = buffer.length * numChannels * bytesPerSample;
        const bufferLength = 44 + dataLength;

        const arrayBuffer = new ArrayBuffer(bufferLength);
        const view = new DataView(arrayBuffer);

        // RIFF identifier
        writeString(view, 0, "RIFF");
        // RIFF chunk length
        view.setUint32(4, 36 + dataLength, true);
        // RIFF type
        writeString(view, 8, "WAVE");
        // format chunk identifier
        writeString(view, 12, "fmt ");
        // format chunk length
        view.setUint32(16, 16, true);
        // sample format (raw)
        view.setUint16(20, format, true);
        // channel count
        view.setUint16(22, numChannels, true);
        // sample rate
        view.setUint32(24, sampleRate, true);
        // byte rate (sample rate * block align)
        view.setUint32(28, sampleRate * blockAlign, true);
        // block align (channel count * bytes per sample)
        view.setUint16(32, blockAlign, true);
        // bits per sample
        view.setUint16(34, bitDepth, true);
        // data chunk identifier
        writeString(view, 36, "data");
        // data chunk length
        view.setUint32(40, dataLength, true);

        // Write the PCM samples
        const channels = [];
        let offset = 44;

        for (let i = 0; i < buffer.numberOfChannels; i++) {
          channels.push(buffer.getChannelData(i));
        }

        while (offset < bufferLength) {
          for (let i = 0; i < numChannels; i++) {
            const sample = Math.max(
              -1,
              Math.min(1, channels[i][(offset / blockAlign) | 0])
            );
            const value =
              (0.5 + sample < 0 ? sample * 32768 : sample * 32767) | 0;
            view.setInt16(offset, value, true);
            offset += bytesPerSample;
          }
        }

        return new Blob([arrayBuffer], { type: "audio/wav" });
      }

      function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) {
          view.setUint8(offset + i, string.charCodeAt(i));
        }
      }

      // MIDI Export functionality
      function saveMIDI() {
        if (recordedNotes.length === 0) return;

        // Convert notes to MIDI format
        const midiData = createMIDIFile();

        // Create download link
        const downloadLink = document.createElement("a");
        downloadLink.href = URL.createObjectURL(
          new Blob([midiData], { type: "audio/midi" })
        );
        downloadLink.download = "piano-recording.mid";

        // Trigger download
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
      }

      function createMIDIFile() {
        // Simple MIDI file creation
        const header = new Uint8Array([
          0x4d,
          0x54,
          0x68,
          0x64, // "MThd"
          0x00,
          0x00,
          0x00,
          0x06, // Header length
          0x00,
          0x00, // Format type 0
          0x00,
          0x01, // Number of tracks
          0x00,
          0x60, // Ticks per quarter note (96)
        ]);

        // Create track data
        const trackEvents = [];
        let currentTime = 0;

        recordedNotes.forEach((note) => {
          const deltaTime = Math.round(note.time * 1000 - currentTime);
          const noteNumber = getNoteNumber(note.noteString);
          const velocity = Math.round(note.velocity * 127);

          // Note on event
          trackEvents.push(...encodeVariableLength(deltaTime));
          trackEvents.push(0x90, noteNumber, velocity);

          // Note off event
          const noteDuration = Math.round(note.duration * 1000);
          trackEvents.push(...encodeVariableLength(noteDuration));
          trackEvents.push(0x80, noteNumber, 0);

          currentTime = note.time * 1000 + noteDuration;
        });

        // End of track
        trackEvents.push(0x00, 0xff, 0x2f, 0x00);

        const trackHeader = new Uint8Array([
          0x4d,
          0x54,
          0x72,
          0x6b, // "MTrk"
          ...intToBytes(trackEvents.length, 4), // Track length
        ]);

        // Combine header, track header, and track data
        const result = new Uint8Array(
          header.length + trackHeader.length + trackEvents.length
        );
        result.set(header, 0);
        result.set(trackHeader, header.length);
        result.set(trackEvents, header.length + trackHeader.length);

        return result;
      }

      function getNoteNumber(noteString) {
        const noteValues = {
          C: 0,
          "C#": 1,
          D: 2,
          "D#": 3,
          E: 4,
          F: 5,
          "F#": 6,
          G: 7,
          "G#": 8,
          A: 9,
          "A#": 10,
          B: 11,
        };

        // Extract note name and octave from string like "C4", "A#3", etc.
        const match = noteString.match(/^([A-G]#?)(\d+)$/);
        if (match) {
          const noteName = match[1];
          const octave = parseInt(match[2]);
          return (octave + 1) * 12 + noteValues[noteName];
        }
        return 60; // Default to middle C if parsing fails
      }

      function encodeVariableLength(value) {
        const result = [];
        result.push(value & 0x7f);
        value >>= 7;
        while (value > 0) {
          result.unshift((value & 0x7f) | 0x80);
          value >>= 7;
        }
        return result;
      }

      function intToBytes(value, byteCount) {
        const result = [];
        for (let i = byteCount - 1; i >= 0; i--) {
          result.push((value >> (i * 8)) & 0xff);
        }
        return result;
      }

      // Event listeners
      document.addEventListener("DOMContentLoaded", () => {
        // Generate piano keyboard
        generatePianoKeyboard();

        // Generate visualizer bars
        updateVisualizer();

        // Set up interval to update visualizer
        setInterval(updateVisualizer, 50);

        // Volume control
        const volumeSlider = document.getElementById("volume");
        const volumeDisplay = document.getElementById("volumeDisplay");

        volumeSlider.addEventListener("input", (event) => {
          volume = parseFloat(event.target.value);
          volumeDisplay.textContent = Math.round(volume * 100) + "%";

          if (masterGainNode) {
            masterGainNode.gain.value = volume;
          }
        });

        // ADSR controls
        ["attack", "decay", "sustain", "release"].forEach((param) => {
          const slider = document.getElementById(param);
          const display = document.getElementById(param + "Display");

          slider.addEventListener("input", (event) => {
            const value = parseFloat(event.target.value);

            switch (param) {
              case "attack":
                attackTime = value;
                display.textContent = value.toFixed(2) + "s";
                break;
              case "decay":
                decayTime = value;
                display.textContent = value.toFixed(2) + "s";
                break;
              case "sustain":
                sustainLevel = value;
                display.textContent = Math.round(value * 100) + "%";
                break;
              case "release":
                releaseTime = value;
                display.textContent = value.toFixed(2) + "s";
                break;
            }
          });
        });

        // Effects controls
        const reverbSlider = document.getElementById("reverb");
        const reverbDisplay = document.getElementById("reverbDisplay");

        reverbSlider.addEventListener("input", (event) => {
          reverbLevel = parseFloat(event.target.value);
          const percentage = Math.round((reverbLevel / 5) * 100);
          reverbDisplay.textContent = percentage + "%";
        });

        const delaySlider = document.getElementById("delay");
        const delayDisplay = document.getElementById("delayDisplay");

        delaySlider.addEventListener("input", (event) => {
          delayLevel = parseFloat(event.target.value);
          delayDisplay.textContent = Math.round(delayLevel * 100) + "%";

          if (audioContext && delayNode) {
            const delayGain = audioContext.createGain();
            delayGain.gain.value = delayLevel;
          }
        });

        const filterSlider = document.getElementById("filter");
        const filterDisplay = document.getElementById("filterDisplay");

        filterSlider.addEventListener("input", (event) => {
          filterFreq = parseFloat(event.target.value);
          const displayValue =
            filterFreq >= 1000
              ? (filterFreq / 1000).toFixed(1) + "kHz"
              : filterFreq + "Hz";
          filterDisplay.textContent = displayValue;

          if (audioContext && filterNode) {
            filterNode.frequency.value = filterFreq;
          }
        });

        // Instrument selector
        const instrumentSelect = document.getElementById("instrument");

        instrumentSelect.addEventListener("change", (event) => {
          currentInstrument = event.target.value;
        });

        // Octave controls
        const octaveDown = document.getElementById("octaveDown");
        const octaveUp = document.getElementById("octaveUp");
        const octaveDisplay = document.getElementById("octaveDisplay");

        octaveDown.addEventListener("click", () => {
          if (currentOctave > 1) {
            currentOctave--;
            octaveDisplay.textContent = currentOctave;
            regeneratePianoKeys(); // Update piano keys with new octave
          }
        });

        octaveUp.addEventListener("click", () => {
          if (currentOctave < 7) {
            currentOctave++;
            octaveDisplay.textContent = currentOctave;
            regeneratePianoKeys(); // Update piano keys with new octave
          }
        });

        // Metronome controls
        const metronomeBtn = document.getElementById("metronomeBtn");
        const tempoDown = document.getElementById("tempoDown");
        const tempoUp = document.getElementById("tempoUp");
        const tempoDisplay = document.getElementById("tempoDisplay");

        metronomeBtn.addEventListener("click", () => {
          initAudio();
          toggleMetronome();
        });

        tempoDown.addEventListener("click", () => {
          if (currentTempo > 60) {
            currentTempo -= 5;
            tempoDisplay.textContent = currentTempo + " BPM";
            if (isMetronomeRunning) {
              toggleMetronome();
              toggleMetronome();
            }
          }
        });

        tempoUp.addEventListener("click", () => {
          if (currentTempo < 200) {
            currentTempo += 5;
            tempoDisplay.textContent = currentTempo + " BPM";
            if (isMetronomeRunning) {
              toggleMetronome();
              toggleMetronome();
            }
          }
        });

        // Scale player controls
        const playScaleBtn = document.getElementById("playScaleBtn");
        playScaleBtn.addEventListener("click", () => {
          initAudio();
          const root = document.getElementById("scaleRoot").value;
          const type = document.getElementById("scaleType").value;
          playScale(root, type);
        });

        // Chord progression controls
        const playProgressionBtn =
          document.getElementById("playProgressionBtn");
        playProgressionBtn.addEventListener("click", () => {
          initAudio();
          const progression =
            document.getElementById("progressionSelect").value;
          if (progression) {
            playProgression(progression);
          }
        });

        // Mouse events for piano keys with velocity sensitivity (using event delegation)
        document.getElementById("piano").addEventListener("mousedown", (event) => {
          if (event.target.classList.contains("key")) {
            const key = event.target;
            const noteString = key.getAttribute("data-note");

            // Calculate velocity based on mouse position and speed
            const rect = key.getBoundingClientRect();
            const relativeY = (event.clientY - rect.top) / rect.height;
            const velocity = Math.min(1, Math.max(0.3, 1 - relativeY * 0.5));

            playNote(noteString, 2, velocity);
            pressKey(key);
          }
        });

        // Touch events for mobile with velocity sensitivity (using event delegation)
        document.getElementById("piano").addEventListener("touchstart", (event) => {
          if (event.target.classList.contains("key")) {
            event.preventDefault();
            const key = event.target;
            const noteString = key.getAttribute("data-note");

            // Calculate velocity based on touch force if available
            const touch = event.touches[0];
            const velocity = touch.force ? Math.min(1, touch.force * 2) : 0.7;

            playNote(noteString, 2, velocity);
            pressKey(key);
          }
        });

        // Keyboard navigation support for piano keys (using event delegation)
        document.getElementById("piano").addEventListener("keydown", (event) => {
          if (event.target.classList.contains("key") && (event.key === "Enter" || event.key === " ")) {
            event.preventDefault();
            const key = event.target;
            const noteString = key.getAttribute("data-note");
            key.setAttribute("aria-pressed", "true");
            playNote(noteString, 2, 0.8);
            pressKey(key);

            // Reset aria-pressed after note duration
            setTimeout(() => {
              key.setAttribute("aria-pressed", "false");
            }, 300);
          }
        });

        // Keyboard events
        document.addEventListener("keydown", (event) => {
          if (event.repeat) return; // Prevent repeat triggers when key is held

          const key = event.key.toLowerCase();
          const keyElement = document.querySelector(`[data-key="${key}"]`);

          if (keyElement) {
            const noteString = keyElement.getAttribute("data-note");
            playNote(noteString);
            pressKey(keyElement);
          }
        });

        // Record button
        const recordBtn = document.getElementById("recordBtn");
        const playBtn = document.getElementById("playBtn");
        const saveBtn = document.getElementById("saveBtn");
        const saveMidiBtn = document.getElementById("saveMidiBtn");

        recordBtn.addEventListener("click", () => {
          if (isRecording) {
            // Stop recording
            isRecording = false;
            recordBtn.textContent = "‚ö´ Record";
            recordBtn.classList.remove("recording");
            playBtn.disabled = false;
            saveBtn.disabled = false;
            saveMidiBtn.disabled = false;
          } else {
            // Start recording
            initAudio();
            isRecording = true;
            recordedNotes = [];
            recordStartTime = audioContext.currentTime;
            recordBtn.textContent = "‚èπ Stop";
            recordBtn.classList.add("recording");
          }
        });

        // Play button
        playBtn.addEventListener("click", () => {
          initAudio();
          playRecording();
        });

        // Save button
        saveBtn.addEventListener("click", () => {
          initAudio();
          saveRecording();
        });

        // Save MIDI button
        saveMidiBtn.addEventListener("click", () => {
          saveMIDI();
        });

        // Chord selector
        const chordSelect = document.getElementById("chordSelect");

        chordSelect.addEventListener("change", (event) => {
          const chord = event.target.value;
          if (chord) {
            initAudio();
            playChord(chord);
          }
        });


        // Initialize audio on first user interaction
        document.addEventListener("click", initAudio, { once: true });
        document.addEventListener("keydown", initAudio, { once: true });
      });


    </script>
  </body>
</html>
