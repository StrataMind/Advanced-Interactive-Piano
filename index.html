<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Interactive Piano</title>
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --dark-color: #222;
            --light-color: #ffffff;
        }
        
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            transition: background 0.5s ease;
        }

        .dark-mode {
            --primary-color: #2d3748;
            --secondary-color: #1a202c;
            --dark-color: #edf2f7;
            --light-color: #2d3748;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-size: 2.5rem;
        }

        .controls-panel {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
        }

        .control-group label {
            margin-bottom: 5px;
            font-weight: bold;
        }

        .piano-container {
            background: #333;
            padding: 20px 20px 30px 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
            perspective: 500px;
            transform-style: preserve-3d;
            transition: transform 0.3s ease;
        }

        .piano-container:hover {
            transform: rotateX(5deg);
        }

        .piano {
            display: flex;
            position: relative;
            background: #222;
            padding: 10px;
            border-radius: 10px;
            box-shadow: inset 0 5px 15px rgba(0,0,0,0.5);
        }

        .key {
            cursor: pointer;
            user-select: none;
            transition: all 0.1s ease;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            padding-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        .key::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .white-key {
            width: 60px;
            height: 220px;
            background: linear-gradient(to bottom, #ffffff 0%, #f0f0f0 100%);
            border: 2px solid #ddd;
            border-radius: 0 0 8px 8px;
            margin: 0 1px;
            color: #666;
        }

        .white-key:hover {
            background: linear-gradient(to bottom, #f0f0f0 0%, #e0e0e0 100%);
        }

        .white-key:active,
        .white-key.pressed {
            background: linear-gradient(to bottom, #e0e0e0 0%, #d0d0d0 100%);
            transform: translateY(3px);
        }

        .white-key.pressed::after {
            opacity: 0.6;
        }

        .black-key {
            width: 36px;
            height: 140px;
            background: linear-gradient(to bottom, #333 0%, #000 100%);
            border: 1px solid #000;
            border-radius: 0 0 5px 5px;
            position: absolute;
            color: #ccc;
            z-index: 2;
        }

        .black-key:hover {
            background: linear-gradient(to bottom, #444 0%, #111 100%);
        }

        .black-key:active,
        .black-key.pressed {
            background: linear-gradient(to bottom, #222 0%, #000 100%);
            transform: translateY(3px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .black-key.pressed::after {
            opacity: 0.3;
        }

        .instructions {
            color: white;
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 10px;
            max-width: 600px;
        }

        input[type="range"] {
            width: 100%;
            margin: 0 10px;
            height: 8px;
            border-radius: 5px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.3);
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
        }

        select, button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        select {
            width: 100%;
        }

        select:focus, button:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5);
        }

        button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        button:active {
            transform: scale(0.97);
        }

        .recording-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .recording {
            color: #ff4c4c;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.7);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }

        @keyframes ripple {
            to {
                transform: scale(2);
                opacity: 0;
            }
        }

        .visualizer-container {
            width: 100%;
            height: 60px;
            margin: 10px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            position: relative;
            overflow: hidden;
        }

        .visualizer {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 100%;
            padding: 0 5px;
        }

        .visualizer-bar {
            background: white;
            width: 5px;
            height: 5px;
            margin: 0 1px;
            border-radius: 3px 3px 0 0;
            transition: height 0.1s ease;
        }

        .note-display {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }

        .piano-range-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.3);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .key-binding {
            position: absolute;
            bottom: 35px;
            font-size: 10px;
            color: #999;
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 6px;
            border-radius: 10px;
        }

        .white-key .key-binding {
            color: #666;
            background: rgba(0, 0, 0, 0.1);
        }

        /* Position black keys */
        .black-key:nth-of-type(1) { left: 40px; } /* C# */
        .black-key:nth-of-type(2) { left: 102px; } /* D# */
        .black-key:nth-of-type(3) { left: 225px; } /* F# */
        .black-key:nth-of-type(4) { left: 285px; } /* G# */
        .black-key:nth-of-type(5) { left: 345px; } /* A# */
        .black-key:nth-of-type(6) { left: 470px; } /* C# */
        .black-key:nth-of-type(7) { left: 530px; } /* D# */

        /* Responsive design */
        @media (max-width: 768px) {
            .white-key {
                width: 40px;
                height: 180px;
            }
            .black-key {
                width: 26px;
                height: 120px;
            }
            /* Adjust black key positions for mobile */
            .black-key:nth-of-type(1) { left: 27px; }
            .black-key:nth-of-type(2) { left: 69px; }
            .black-key:nth-of-type(3) { left: 153px; }
            .black-key:nth-of-type(4) { left: 195px; }
            .black-key:nth-of-type(5) { left: 237px; }
            .black-key:nth-of-type(6) { left: 321px; }
            .black-key:nth-of-type(7) { left: 363px; }
        }

        @media (max-width: 480px) {
            .controls-panel {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            .control-group {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <button class="theme-toggle" id="themeToggle">🌙 Dark Mode</button>
    
    <h1>🎹 Advanced Interactive Piano</h1>
    
    <div class="controls-panel">
        <div class="control-group">
            <label for="volume">Volume</label>
            <input type="range" id="volume" min="0" max="1" step="0.05" value="0.5">
            <span id="volumeDisplay">50%</span>
        </div>

        <div class="control-group">
            <label for="instrument">Instrument</label>
            <select id="instrument">
                <option value="sine">Piano</option>
                <option value="square">Organ</option>
                <option value="sawtooth">Synth</option>
                <option value="triangle">Music Box</option>
            </select>
        </div>

        <div class="control-group">
            <label for="reverb">Reverb</label>
            <input type="range" id="reverb" min="0" max="5" step="0.1" value="0.5">
            <span id="reverbDisplay">10%</span>
        </div>

        <div class="control-group">
            <label for="octave">Octave</label>
            <div class="piano-range-controls">
                <button id="octaveDown">-</button>
                <span id="octaveDisplay">4</span>
                <button id="octaveUp">+</button>
            </div>
        </div>
    </div>

    <div class="visualizer-container">
        <div class="visualizer" id="visualizer"></div>
    </div>
    
    <div class="note-display" id="noteDisplay">-</div>

    <div class="piano-container">
        <div class="piano" id="piano">
            <!-- White keys -->
            <div class="key white-key" data-note="C" data-key="a">C<span class="key-binding">A</span></div>
            <div class="key white-key" data-note="D" data-key="s">D<span class="key-binding">S</span></div>
            <div class="key white-key" data-note="E" data-key="d">E<span class="key-binding">D</span></div>
            <div class="key white-key" data-note="F" data-key="f">F<span class="key-binding">F</span></div>
            <div class="key white-key" data-note="G" data-key="g">G<span class="key-binding">G</span></div>
            <div class="key white-key" data-note="A" data-key="h">A<span class="key-binding">H</span></div>
            <div class="key white-key" data-note="B" data-key="j">B<span class="key-binding">J</span></div>
            <div class="key white-key" data-note="C2" data-key="k">C<span class="key-binding">K</span></div>
            <div class="key white-key" data-note="D2" data-key="l">D<span class="key-binding">L</span></div>
            
            <!-- Black keys -->
            <div class="key black-key" data-note="C#" data-key="w">C#<span class="key-binding">W</span></div>
            <div class="key black-key" data-note="D#" data-key="e">D#<span class="key-binding">E</span></div>
            <div class="key black-key" data-note="F#" data-key="t">F#<span class="key-binding">T</span></div>
            <div class="key black-key" data-note="G#" data-key="y">G#<span class="key-binding">Y</span></div>
            <div class="key black-key" data-note="A#" data-key="u">A#<span class="key-binding">U</span></div>
            <div class="key black-key" data-note="C#2" data-key="o">C#<span class="key-binding">O</span></div>
            <div class="key black-key" data-note="D#2" data-key="p">D#<span class="key-binding">P</span></div>
        </div>
    </div>

    <div class="controls-panel">
        <div class="control-group">
            <label>Recording</label>
            <div class="recording-controls">
                <button id="recordBtn">⚫ Record</button>
                <button id="playBtn" disabled>▶ Play</button>
                <button id="saveBtn" disabled>💾 Save</button>
            </div>
        </div>

        <div class="control-group">
            <label>Chord Player</label>
            <select id="chordSelect">
                <option value="">Select a chord</option>
                <option value="C">C Major</option>
                <option value="Cm">C Minor</option>
                <option value="C7">C7</option>
                <option value="G">G Major</option>
                <option value="Gm">G Minor</option>
                <option value="F">F Major</option>
                <option value="D">D Major</option>
                <option value="A">A Major</option>
                <option value="E">E Major</option>
            </select>
        </div>
    </div>

    <div class="instructions">
        <p>🎵 Click the keys, use your keyboard, or select chords to play!</p>
        <p>White keys: A S D F G H J K L | Black keys: W E T Y U O P</p>
        <p>Adjust volume, instrument type, reverb, and octave to customize your sound.</p>
        <p>Record your performance and save it as an audio file!</p>
    </div>

    <script>
        // State variables
        let audioContext;
        let masterGainNode;
        let reverbNode;
        let volume = 0.5;
        let reverbLevel = 0.5;
        let currentInstrument = 'sine';
        let currentOctave = 4;
        let isRecording = false;
        let recordedNotes = [];
        let recordStartTime = 0;
        let activeNotes = new Map(); // To track currently playing notes
        let isDarkMode = false;

        // Create visualizer bars
        const visualizer = document.getElementById('visualizer');
        const barCount = 32;
        for (let i = 0; i < barCount; i++) {
            const bar = document.createElement('div');
            bar.className = 'visualizer-bar';
            visualizer.appendChild(bar);
        }
        const visualizerBars = document.querySelectorAll('.visualizer-bar');

        // Initialize audio context
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Create master gain node for volume control
                masterGainNode = audioContext.createGain();
                masterGainNode.gain.value = volume;
                masterGainNode.connect(audioContext.destination);
                
                // Create convolver node for reverb
                reverbNode = audioContext.createConvolver();
                createReverb();
            }
        }

        // Create reverb impulse response
        function createReverb() {
            const duration = 2.0;
            const decay = 2.0;
            const sampleRate = audioContext.sampleRate;
            const length = sampleRate * duration;
            const impulse = audioContext.createBuffer(2, length, sampleRate);
            const leftChannel = impulse.getChannelData(0);
            const rightChannel = impulse.getChannelData(1);
            
            for (let i = 0; i < length; i++) {
                const n = i / length;
                // Random noise with exponential decay
                leftChannel[i] = (Math.random() * 2 - 1) * Math.pow(1 - n, decay);
                rightChannel[i] = (Math.random() * 2 - 1) * Math.pow(1 - n, decay);
            }
            
            reverbNode.buffer = impulse;
            
            // Connect the reverb in parallel with dry signal
            const reverbGain = audioContext.createGain();
            reverbGain.gain.value = reverbLevel;
            reverbNode.connect(reverbGain);
            reverbGain.connect(masterGainNode);
        }

        // Calculate note frequency based on note name and octave
        function getFrequency(noteName, octave) {
            const notes = {
                'C': 0, 'C#': 1, 'D': 2, 'D#': 3,
                'E': 4, 'F': 5, 'F#': 6, 'G': 7,
                'G#': 8, 'A': 9, 'A#': 10, 'B': 11
            };
            
            // For second octave notes
            if (noteName.includes('2')) {
                octave++;
                noteName = noteName.replace('2', '');
            }
            
            const semitonesFromA4 = (octave - 4) * 12 + notes[noteName] - notes['A'];
            return 440 * Math.pow(2, semitonesFromA4 / 12);
        }

        // Play a note
        function playNote(noteName, duration = 2) {
            initAudio();
            
            // Display the note being played
            document.getElementById('noteDisplay').textContent = noteName + currentOctave;
            
            // Calculate frequency based on note name and current octave
            const frequency = getFrequency(noteName, currentOctave);
            
            // Create oscillator and gain nodes
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            // Connect nodes: oscillator -> gain -> reverb & master
            oscillator.connect(gainNode);
            gainNode.connect(masterGainNode);
            gainNode.connect(reverbNode);
            
            // Set oscillator properties
            oscillator.frequency.value = frequency;
            oscillator.type = currentInstrument;
            
            // Set envelope
            gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
            
            // Start and stop the oscillator
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
            
            // Store the note for active visualization
            const noteInfo = {
                frequency,
                gainNode,
                oscillator,
                startTime: audioContext.currentTime
            };
            activeNotes.set(noteName, noteInfo);
            
            // Remove from active notes after it stops
            setTimeout(() => {
                activeNotes.delete(noteName);
            }, duration * 1000);
            
            // Record the note if recording is active
            if (isRecording) {
                recordedNotes.push({
                    note: noteName,
                    octave: currentOctave,
                    time: audioContext.currentTime - recordStartTime,
                    duration: duration
                });
            }
            
            // Animate visualizer for this note
            animateVisualizer(frequency);
            
            return { oscillator, gainNode };
        }

        // Animate visualizer
        function animateVisualizer(frequency) {
            // Map frequency to a position in the visualizer
            const normalizedFreq = Math.min(Math.max(frequency / 1000, 0), 1);
            const barIndex = Math.floor(normalizedFreq * barCount);
            
            // Animate all bars with emphasis on the frequency's bar
            visualizerBars.forEach((bar, index) => {
                let height;
                if (index === barIndex) {
                    height = 95; // Main frequency bar
                } else {
                    // Height decreases as distance from main bar increases
                    const distance = Math.abs(index - barIndex);
                    height = Math.max(5, 95 - (distance * 15));
                }
                
                // Add some randomness
                height += Math.random() * 10 - 5;
                
                // Ensure height is within bounds
                height = Math.max(5, Math.min(95, height));
                
                // Apply the height
                bar.style.height = height + '%';
                
                // Color based on frequency (hue)
                const hue = (normalizedFreq * 270) % 360;
                bar.style.background = `hsl(${hue}, 80%, 60%)`;
            });
        }

        // Update visualizer based on active notes
        function updateVisualizer() {
            if (activeNotes.size === 0) {
                // No active notes, reset visualizer
                visualizerBars.forEach(bar => {
                    bar.style.height = '5%';
                    bar.style.background = 'white';
                });
                return;
            }
            
            // Calculate average frequency of all active notes
            let totalFreq = 0;
            activeNotes.forEach(note => {
                totalFreq += note.frequency;
            });
            const avgFreq = totalFreq / activeNotes.size;
            
            // Animate visualizer based on average frequency
            animateVisualizer(avgFreq);
        }

        // Handle key press visual feedback
        function pressKey(keyElement) {
            if (!keyElement) return;
            
            // Add pressed class for styling
            keyElement.classList.add('pressed');
            
            // Add ripple effect
            const ripple = document.createElement('div');
            ripple.className = 'ripple';
            keyElement.appendChild(ripple);
            
            // Clean up after animation
            setTimeout(() => {
                keyElement.classList.remove('pressed');
                ripple.remove();
            }, 300);
        }

        // Play a chord
        function playChord(chordName) {
            const chords = {
                'C': ['C', 'E', 'G'],
                'Cm': ['C', 'D#', 'G'],
                'C7': ['C', 'E', 'G', 'A#'],
                'G': ['G', 'B', 'D2'],
                'Gm': ['G', 'A#', 'D2'],
                'F': ['F', 'A', 'C2'],
                'D': ['D', 'F#', 'A'],
                'A': ['A', 'C#2', 'E'],
                'E': ['E', 'G#', 'B']
            };
            
            if (!chords[chordName]) return;
            
            // Play each note in the chord
            chords[chordName].forEach((note, index) => {
                setTimeout(() => {
                    // Find the key element
                    const keyElement = document.querySelector(`[data-note="${note}"]`);
                    if (keyElement) {
                        // Visually press the key
                        pressKey(keyElement);
                        // Play the note
                        playNote(note);
                    }
                }, index * 30); // Slight delay between notes for arpeggio effect
            });
        }

        // Play recorded notes
        function playRecording() {
            if (recordedNotes.length === 0) return;
            
            // Disable buttons during playback
            document.getElementById('playBtn').disabled = true;
            document.getElementById('recordBtn').disabled = true;
            
            // Reset any active notes
            activeNotes.clear();
            
            // Get the starting time
            const startTime = audioContext.currentTime;
            
            // Play each recorded note at its recorded time
            recordedNotes.forEach(noteInfo => {
                setTimeout(() => {
                    // Find the key element
                    const keyElement = document.querySelector(`[data-note="${noteInfo.note}"]`);
                    if (keyElement) {
                        // Temporarily set the octave to the recorded one
                        const originalOctave = currentOctave;
                        currentOctave = noteInfo.octave;
                        
                        // Visually press the key
                        pressKey(keyElement);
                        
                        // Play the note
                        playNote(noteInfo.note, noteInfo.duration);
                        
                        // Restore original octave
                        currentOctave = originalOctave;
                    }
                }, noteInfo.time * 1000);
            });
            
            // Re-enable buttons after playback finishes
            const lastNote = recordedNotes[recordedNotes.length - 1];
            const recordingDuration = lastNote.time + lastNote.duration;
            
            setTimeout(() => {
                document.getElementById('playBtn').disabled = false;
                document.getElementById('recordBtn').disabled = false;
            }, recordingDuration * 1000 + 100);
        }

        // Save recording as audio file
        function saveRecording() {
            if (recordedNotes.length === 0) return;
            
            // Create offline audio context for rendering
            const offlineCtx = new OfflineAudioContext(
                2, // stereo
                44100 * 60, // 60 seconds max at 44.1kHz
                44100 // sample rate
            );
            
            // Create master gain node for the offline context
            const offlineMaster = offlineCtx.createGain();
            offlineMaster.gain.value = volume;
            offlineMaster.connect(offlineCtx.destination);
            
            // Render each note
            recordedNotes.forEach(noteInfo => {
                const oscillator = offlineCtx.createOscillator();
                const gainNode = offlineCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(offlineMaster);
                
                oscillator.type = currentInstrument;
                oscillator.frequency.value = getFrequency(noteInfo.note, noteInfo.octave);
                
                const startTime = noteInfo.time;
                const stopTime = startTime + noteInfo.duration;
                
                gainNode.gain.setValueAtTime(volume, startTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, stopTime);
                
                oscillator.start(startTime);
                oscillator.stop(stopTime);
            });
            
            // Get the last note to determine recording length
            const lastNote = recordedNotes[recordedNotes.length - 1];
            const recordingDuration = lastNote.time + lastNote.duration;
            
            // Start rendering
            offlineCtx.startRendering().then(renderedBuffer => {
                // Create WAV file from buffer
                const wavBlob = audioBufferToWav(renderedBuffer);
                
                // Create download link
                const downloadLink = document.createElement('a');
                downloadLink.href = URL.createObjectURL(wavBlob);
                downloadLink.download = 'piano-recording.wav';
                
                // Trigger download
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
            }).catch(err => {
                console.error('Error rendering audio:', err);
            });
        }

        // Convert AudioBuffer to WAV format
        // Based on https://github.com/Jam3/audiobuffer-to-wav
        function audioBufferToWav(buffer) {
            const numChannels = buffer.numberOfChannels;
            const sampleRate = buffer.sampleRate;
            const format = 1; // PCM
            const bitDepth = 16;
            
            const bytesPerSample = bitDepth / 8;
            const blockAlign = numChannels * bytesPerSample;
            
            const dataLength = buffer.length * numChannels * bytesPerSample;
            const bufferLength = 44 + dataLength;
            
            const arrayBuffer = new ArrayBuffer(bufferLength);
            const view = new DataView(arrayBuffer);
            
            // RIFF identifier
            writeString(view, 0, 'RIFF');
            // RIFF chunk length
            view.setUint32(4, 36 + dataLength, true);
            // RIFF type
            writeString(view, 8, 'WAVE');
            // format chunk identifier
            writeString(view, 12, 'fmt ');
            // format chunk length
            view.setUint32(16, 16, true);
            // sample format (raw)
            view.setUint16(20, format, true);
            // channel count
            view.setUint16(22, numChannels, true);
            // sample rate
            view.setUint32(24, sampleRate, true);
            // byte rate (sample rate * block align)
            view.setUint32(28, sampleRate * blockAlign, true);
            // block align (channel count * bytes per sample)
            view.setUint16(32, blockAlign, true);
            // bits per sample
            view.setUint16(34, bitDepth, true);
            // data chunk identifier
            writeString(view, 36, 'data');
            // data chunk length
            view.setUint32(40, dataLength, true);
            
            // Write the PCM samples
            const channels = [];
            let offset = 44;
            
            for (let i = 0; i < buffer.numberOfChannels; i++) {
                channels.push(buffer.getChannelData(i));
            }
            
            while (offset < bufferLength) {
                for (let i = 0; i < numChannels; i++) {
                    const sample = Math.max(-1, Math.min(1, channels[i][offset / blockAlign | 0]));
                    const value = (0.5 + sample < 0 ? sample * 32768 : sample * 32767) | 0;
                    view.setInt16(offset, value, true);
                    offset += bytesPerSample;
                }
            }
            
            return new Blob([arrayBuffer], { type: 'audio/wav' });
        }
        
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Generate visualizer bars
            updateVisualizer();
            
            // Set up interval to update visualizer
            setInterval(updateVisualizer, 50);
            
            // Volume control
            const volumeSlider = document.getElementById('volume');
            const volumeDisplay = document.getElementById('volumeDisplay');
            
            volumeSlider.addEventListener('input', (event) => {
                volume = parseFloat(event.target.value);
                volumeDisplay.textContent = Math.round(volume * 100) + '%';
                
                if (masterGainNode) {
                    masterGainNode.gain.value = volume;
                }
            });
            
            // Reverb control
            const reverbSlider = document.getElementById('reverb');
            const reverbDisplay = document.getElementById('reverbDisplay');
            
            reverbSlider.addEventListener('input', (event) => {
                reverbLevel = parseFloat(event.target.value);
                const percentage = Math.round((reverbLevel / 5) * 100);
                reverbDisplay.textContent = percentage + '%';
                
                if (audioContext && reverbNode) {
                    // Reconnect with new reverb level
                    const reverbGain = audioContext.createGain();
                    reverbGain.gain.value = reverbLevel;
                    reverbNode.disconnect();
                    reverbNode.connect(reverbGain);
                    reverbGain.connect(masterGainNode);
                }
            });
            
            // Instrument selector
            const instrumentSelect = document.getElementById('instrument');
            
            instrumentSelect.addEventListener('change', (event) => {
                currentInstrument = event.target.value;
            });
            
            // Octave controls
            const octaveDown = document.getElementById('octaveDown');
            const octaveUp = document.getElementById('octaveUp');
            const octaveDisplay = document.getElementById('octaveDisplay');
            
            octaveDown.addEventListener('click', () => {
                if (currentOctave > 1) {
                    currentOctave--;
                    octaveDisplay.textContent = currentOctave;
                }
            });
            
            octaveUp.addEventListener('click', () => {
                if (currentOctave < 7) {
                    currentOctave++;
                    octaveDisplay.textContent = currentOctave;
                }
            });
            
            // Mouse events for piano keys
            document.querySelectorAll('.key').forEach(key => {
                key.addEventListener('mousedown', () => {
                    const note = key.getAttribute('data-note');
                    playNote(note);
                    pressKey(key);
                });
            });
            
            // Keyboard events
            document.addEventListener('keydown', (event) => {
                if (event.repeat) return; // Prevent repeat triggers when key is held
                
                const key = event.key.toLowerCase();
                const keyElement = document.querySelector(`[data-key="${key}"]`);
                
                if (keyElement) {
                    const note = keyElement.getAttribute('data-note');
                    playNote(note);
                    pressKey(keyElement);
                }
            });
            
            // Record button
            const recordBtn = document.getElementById('recordBtn');
            const playBtn = document.getElementById('playBtn');
            const saveBtn = document.getElementById('saveBtn');
            
            recordBtn.addEventListener('click', () => {
                if (isRecording) {
                    // Stop recording
                    isRecording = false;
                    recordBtn.textContent = '⚫ Record';
                    recordBtn.classList.remove('recording');
                    playBtn.disabled = false;
                    saveBtn.disabled = false;
                } else {
                    // Start recording
                    initAudio();
                    isRecording = true;
                    recordedNotes = [];
                    recordStartTime = audioContext.currentTime;
                    recordBtn.textContent = '⏹ Stop';
                    recordBtn.classList.add('recording');
                }
            });
            
            // Play button
            playBtn.addEventListener('click', () => {
                initAudio();
                playRecording();
            });
            
            // Save button
            saveBtn.addEventListener('click', () => {
                initAudio();
                saveRecording();
            });
            
            // Chord selector
            const chordSelect = document.getElementById('chordSelect');
            
            chordSelect.addEventListener('change', (event) => {
                const chord = event.target.value;
                if (chord) {
                    initAudio();
                    playChord(chord);
                }
            });
            
            // Theme toggle
            const themeToggle = document.getElementById('themeToggle');
            
            themeToggle.addEventListener('click', () => {
                isDarkMode = !isDarkMode;
                if (isDarkMode) {
                    document.body.classList.add('dark-mode');
                    themeToggle.innerHTML = '☀️ Light Mode';
                } else {
                    document.body.classList.remove('dark-mode');
                    themeToggle.innerHTML = '🌙 Dark Mode';
                }
            });
            
            // Initialize audio on first user interaction
            document.addEventListener('click', initAudio, { once: true });
            document.addEventListener('keydown', initAudio, { once: true });
        });
    </script>
</body>
</html>